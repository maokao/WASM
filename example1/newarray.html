<!DOCTYPE html>
<html>
  <head>
    <title>wasm example1</title>
  </head>
  <body>
    <script type="text/javascript" src="newarray.js"></script>
    <script>
//emcc newarray.cpp -s "EXPORTED_FUNCTIONS=['_getArray']" -s "EXTRA_EXPORTED_RUNTIME_METHODS=['ccall','cwrap']" -o newarray.js
//emrun --no_browser --port 8000 .

var buffer = new ArrayBuffer(12);

Module['onRuntimeInitialized'] = onRuntimeInitialized;

// 將js的typedarray複製到wasm的堆記憶體
function copyToHeap(typedArray) {
  const numBytes = typedArray.byteLength*Uint8Array.BYTES_PER_ELEMENT;
  const ptr = Module._malloc(numBytes);
  const heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
  heapBytes.set(new Uint8Array(typedArray.buffer));
  return heapBytes;
}
// 釋放一塊wasm記憶體
function freeHeap(heapBytes) {
  Module._free(heapBytes.byteOffset);
}

function onRuntimeInitialized() {
  const jsArray = [1,2,3,4,5,6];
  var len = jsArray.length;
  const ptr = Module._malloc(jsArray.length*Int32Array.BYTES_PER_ELEMENT);

  var newptr = Module.ccall(
    "getArray",
    "number",
    ["number"],
    [len]
  );

  var output_array = new Int32Array(Module.HEAP32.buffer, newptr, len);
  console.log(output_array);

  freeHeap(ptr);
}
    </script>
  </body>
</html>